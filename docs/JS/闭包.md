---
nav:
  title: JS
order: 2
---

# 闭包

## 1.什么是闭包

**闭包（Closure）**:一个函数可以记住外部变量并且可以访问这些变量

## 2.闭包产生的原因

和 js 的内部运行机制有关

JavaScript 中的函数会自动通过隐藏的 `[[Environment]]` 属性记住创建它们的位置，所以它们都可以访问外部变量

### 词法环境

> 在 js 中，每个运行的函数，代码块以及整个脚本，都有一个被称为**词法环境**的内部（隐藏）的关联对象
>
> 词法环境是一种包含标识符=>变量 映射关系的一种结构

**组成部分**

- **环境记录(EnvironmentRecord)**:储存所有局部变量的对象
- **对外部词法环境的引用(outer)**:当前可以访问的外部词法环境

**词法环境类型**

- **全局环境**：全局执行上下文，他没有外部环境的引用，拥有一个全局队形 window 和关联的方法和属性：Math,Date 等。还有用户定义的全局变量，并将 this 指向全局对象

  > 一个"变量"只是**环境记录**这个特殊的内部对象的一个属性。获取或者修改变量意味着获取或者修改这个环境变量中的属性

- **函数环境**：用户在函数定义的变量将存储在环境记录中。对外部环境的引用可以是全局环境，也可以是包含内部函数的外部函数环境。

## 3.闭包的缺点

闭包会导致内存占用过高,因为变量都没有释放内存

## 4.常见面试题

### 1.for 循环中打印

```js
for (var i = 0; i < 4; i++) {
  setTimeout(function () {
    console.log(i);
  }, 300);
}
```

> 结果是，4,4,4,4
>
> js 执行的时候首先会执行主线程，异步相关的会到异步队列中去，当主线程执行完毕后开始执行异步队列，当主线程执行完毕开始执行异步任务，此事 i 的值为 4

**修改，变为 1,2,3,4**

```
for (var i =0;i<4;i++){
setTimeout(
    (function(i) {
      return function() {
        console.log(i);
      };
    })(i),
    300
  );
}
```
